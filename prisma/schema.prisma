generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employee {
  id                     String    @id @default(uuid())
  employee_code          String    @unique
  name                   String
  email                  String    @unique
  username               String    @unique @default("")
  password_hash          String    @default("temp_password_to_change")
  phone                  String?
  role                   Role      @default(employee)
  department             String?   @default("Operations")
  zone_id                String?
  allowed_quota_liters   Float     @default(100)
  is_banned              Boolean   @default(false)
  allowed_zones          String[]
  password_reset_token   String?   @unique
  password_reset_expires DateTime?
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt
  approver_claims        Claim[]   @relation("ApproverClaims")
  claims                 Claim[]
  zone                   Zone?     @relation("EmployeeZone", fields: [zone_id], references: [id])
  vehicles               Vehicle[]
  trips                  OfficialTrip[]

  @@index([zone_id])
  @@index([role])
  @@map("employees")
}

model Vehicle {
  id                   String    @id @default(uuid())
  reg_no               String    @unique
  model                String?
  assigned_employee_id String?
  avg_mileage          Float?
  last_odometer        Int?
  next_service_km      Int?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt
  claims               Claim[]
  assigned_employee    Employee? @relation(fields: [assigned_employee_id], references: [id])
  trips                OfficialTrip[]

  @@index([assigned_employee_id])
  @@map("vehicles")
}

model Claim {
  id               String        @id @default(uuid())
  employee_id      String
  vehicle_id       String
  pump_id          String?
  liters_claimed   Float
  price            Decimal
  odometer_reading Int?
  gps_lat          Float?
  gps_lng          Float?
  photos           String[]
  ocr_text         Json?
  ocr_confidence   Float?
  fraud_score      Float?
  status           ClaimStatus   @default(pending)
  approver_id      String?
  rejection_reason String?
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  approver         Employee?     @relation("ApproverClaims", fields: [approver_id], references: [id])
  employee         Employee      @relation(fields: [employee_id], references: [id])
  vehicle          Vehicle       @relation(fields: [vehicle_id], references: [id])
  images           Image[]
  location_logs    LocationLog[]

  @@index([employee_id])
  @@index([vehicle_id])
  @@index([status])
  @@index([created_at])
  @@map("claims")
}

model Image {
  id             String    @id @default(uuid())
  claim_id       String
  type           ImageType
  file_url       String
  checksum       String?
  phash          String?
  exif_timestamp DateTime?
  uploaded_at    DateTime  @default(now())
  claim          Claim     @relation(fields: [claim_id], references: [id], onDelete: Cascade)

  @@index([claim_id])
  @@map("images")
}

model Zone {
  id              String        @id @default(uuid())
  name            String
  center_lat      Float?
  center_lng      Float?
  radius_km       Float?
  geojson         Json?
  active          Boolean       @default(true)
  vehicle_count   Int           @default(0)
  violation_count Int           @default(0)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @default(now()) @updatedAt
  employees       Employee[]    @relation("EmployeeZone")
  location_logs   LocationLog[]

  @@index([active])
  @@map("zones")
}

model LocationLog {
  id             String   @id @default(uuid())
  claim_id       String?
  employee_id    String
  vehicle_id     String
  latitude       Float
  longitude      Float
  address        String?
  is_within_zone Boolean
  zone_id        String?
  timestamp      DateTime @default(now())
  claim          Claim?   @relation(fields: [claim_id], references: [id])
  zone           Zone?    @relation(fields: [zone_id], references: [id])

  @@index([claim_id])
  @@index([employee_id])
  @@index([zone_id])
  @@map("location_logs")
}

model OfficialTrip {
  id                String           @id @default(uuid())
  employee_id       String
  vehicle_id        String
  trip_type         String            // "Head Office", "Official Visit", "Field Work", etc.
  destination       String
  start_location    String
  start_lat         Float?
  start_lng         Float?
  end_lat           Float?
  end_lng           Float?
  purpose           String?
  approved_by_id    String?
  is_approved       Boolean           @default(false)
  approved_at       DateTime?
  trip_status       TripStatus        @default(active)
  total_distance_km Float?
  total_cost        Decimal?          @default(0)
  start_time        DateTime          @default(now())
  end_time          DateTime?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt
  employee          Employee          @relation(fields: [employee_id], references: [id])
  vehicle           Vehicle           @relation(fields: [vehicle_id], references: [id])
  expenses          TripExpense[]
  location_logs     TripLocationLog[]
  receipts          TripReceipt[]

  @@index([employee_id])
  @@index([vehicle_id])
  @@index([trip_status])
  @@index([created_at])
  @@map("official_trips")
}

model TripExpense {
  id                String       @id @default(uuid())
  trip_id           String
  expense_type      ExpenseType
  amount            Decimal
  description       String?
  location          String?
  latitude          Float?
  longitude         Float?
  timestamp         DateTime     @default(now())
  photo_url         String?
  receipt_url       String?
  created_at        DateTime     @default(now())
  trip              OfficialTrip @relation(fields: [trip_id], references: [id], onDelete: Cascade)

  @@index([trip_id])
  @@map("trip_expenses")
}

model TripReceipt {
  id          String       @id @default(uuid())
  trip_id     String
  receipt_type ReceiptType
  file_url    String
  amount      Decimal
  location    String?
  latitude    Float?
  longitude   Float?
  timestamp   DateTime     @default(now())
  notes       String?
  created_at  DateTime     @default(now())
  trip        OfficialTrip @relation(fields: [trip_id], references: [id], onDelete: Cascade)

  @@index([trip_id])
  @@map("trip_receipts")
}

model TripLocationLog {
  id          String       @id @default(uuid())
  trip_id     String
  latitude    Float
  longitude   Float
  address     String?
  timestamp   DateTime     @default(now())
  trip        OfficialTrip @relation(fields: [trip_id], references: [id], onDelete: Cascade)

  @@index([trip_id])
  @@index([timestamp])
  @@map("trip_location_logs")
}

enum Role {
  employee
  approver
  admin
}

enum ClaimStatus {
  submitted
  pending
  approved
  rejected
}

enum ImageType {
  receipt
  odometer
  pump
  other
}

enum TripStatus {
  active
  completed
  cancelled
  pending
}

enum ExpenseType {
  fuel
  toll
  parking
  maintenance
  other
}

enum ReceiptType {
  fuel
  toll_tax
  parking
  food
  accommodation
  other
}
